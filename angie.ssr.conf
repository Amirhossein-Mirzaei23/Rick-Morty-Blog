load_module /usr/lib/angie/modules/ngx_http_brotli_filter_module.so;
load_module /usr/lib/angie/modules/ngx_http_brotli_static_module.so;
load_module /usr/lib/angie/modules/ngx_http_zstd_filter_module.so;
load_module /usr/lib/angie/modules/ngx_http_zstd_static_module.so;

user  angie;
worker_processes  auto;
worker_rlimit_nofile 8192;

error_log  /var/log/angie/error.log notice;
pid        /var/run/angie.pid;

events {
    worker_connections  4096;
    use epoll;
    multi_accept on;
}

http {
    include       /etc/angie/mime.types;
    default_type  application/octet-stream;

    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for"';

    access_log  /var/log/angie/access.log  main buffer=16k;

    sendfile        on;
    tcp_nopush      on;
    tcp_nodelay     on;
    keepalive_timeout  20s;
    keepalive_requests 100;
    server_tokens  off;

    open_file_cache max=1000 inactive=20s;
    open_file_cache_valid 30s;
    open_file_cache_min_uses 1;
    open_file_cache_errors off;

    # ── Compression ────────────────────────────────────────────
    # Static pre-compressed files (served by priority order):
    #   .zst → .br → .gz (browser's Accept-Encoding decides)
    # zstd_static   on;
    brotli_static on;
    gzip_static   on;

    # Dynamic Brotli for responses not served from disk
    brotli           on;
    brotli_comp_level 4;
    brotli_types text/plain text/css application/json application/javascript
                 text/xml application/xml image/svg+xml;

    # Dynamic Gzip as universal fallback
    gzip          on;
    gzip_vary     on;
    gzip_proxied  any;
    gzip_comp_level 6;
    gzip_types text/plain text/css application/json application/javascript
               text/xml application/xml image/svg+xml;

    # ── Upstream: Nuxt SSR node server ─────────────────────────
    # Override via env: NUXT_HOST / NUXT_PORT or docker-compose
    # service name must resolve to the Node.js container.
    upstream nuxt_ssr {
        server nuxt-app:3000;   # change "nuxt-app" to your service name
        keepalive 32;
    }

    server {
        listen       80 default_server;
        listen       [::]:80 default_server;
        # Uncomment for HTTPS + HTTP/2:
        # listen 443 ssl http2;

        server_name  _;

        # Security headers
        add_header X-Frame-Options         "SAMEORIGIN"             always;
        add_header X-XSS-Protection        "1; mode=block"          always;
        add_header X-Content-Type-Options  "nosniff"                always;
        add_header Referrer-Policy         "no-referrer-when-downgrade" always;

        # ── Favicon ──────────────────────────────────────────────
        location = /favicon.ico {
            expires 1y;
            add_header Cache-Control "public, immutable";
            try_files $uri =404;
            access_log off;
        }

        # ── Nuxt 4 hashed JS/CSS bundles ─────────────────────────
        # Content-addressed (hash in filename) → safe to cache forever.
        # If the statics container is separate this location will never
        # match; remove it and let the proxy handle everything.
        location ^~ /_nuxt/ {
            root /usr/share/angie/html;   # mapped from compressor stage
            expires max;
            add_header Cache-Control "public, max-age=31536000, immutable";
            add_header X-Content-Type-Options "nosniff" always;
            try_files $uri @ssr;          # fall through to SSR if not found
            access_log off;
        }

        # ── Fonts & binary public assets ─────────────────────────
        location ~* \.(woff2?|ttf|otf|eot|ico|jpg|jpeg|png|gif|webp|avif|mp4|webm)$ {
            root /usr/share/angie/html;
            expires 1y;
            add_header Cache-Control "public, immutable";
            try_files $uri @ssr;
            access_log off;
        }

        # ── Short-lived public assets (manifest, sitemap, etc.) ──
        location ~* \.(xml|webmanifest|txt)$ {
            root /usr/share/angie/html;
            expires 1h;
            add_header Cache-Control "public";
            try_files $uri @ssr;
        }

        # ── robots.txt ───────────────────────────────────────────
        location = /robots.txt {
            root /usr/share/angie/html;
            expires 1d;
            try_files $uri @ssr;
            access_log off;
        }

        # ── All other requests → Nuxt SSR ────────────────────────
        location / {
            proxy_pass         http://nuxt_ssr;
            proxy_http_version 1.1;
            proxy_set_header   Connection      "";       # enable keepalive
            proxy_set_header   Host            $host;
            proxy_set_header   X-Real-IP       $remote_addr;
            proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header   X-Forwarded-Proto $scheme;

            proxy_connect_timeout  5s;
            proxy_read_timeout    30s;
            proxy_send_timeout    30s;

            # SSR HTML is generated per-request; no proxy cache
            proxy_cache off;
        }

        # Named location used as fallback when static file is absent
        location @ssr {
            proxy_pass         http://nuxt_ssr;
            proxy_http_version 1.1;
            proxy_set_header   Connection      "";
            proxy_set_header   Host            $host;
            proxy_set_header   X-Real-IP       $remote_addr;
            proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header   X-Forwarded-Proto $scheme;
        }

        error_page 500 502 503 504 /50x.html;
        location = /50x.html {
            root /usr/share/angie/html;
        }
    }
}
